<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %} - Mega Tienda</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <img src="{{ url_for('static', filename='img/logo2.png') }}" alt="Tienda Online" class="img-fluid imgnav rounded-4 shadow-lg">
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
           <!-- Buscador mejorado -->
            
            <div class="collapse navbar-collapse" id="navbarNav">
                
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">Inicio</a>
                    </li>
                    
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Categorías
                        </a>
                        <ul class="dropdown-menu border-0 shadow-sm" aria-labelledby="navbarDropdown">
                            {% for categoria in categorias_principales %}
                            <li>
                                <a class="dropdown-item d-flex align-items-center py-2" 
                                   href="{{ url_for('mostrar_categoria', categoria_id=categoria.id) }}">
                                    <i class="fas fa-{{ categoria.icono|default('tags') }} me-2 text-primary"></i>
                                    {{ categoria.nombre }}
                                </a>
                            </li>
                            {% endfor %}
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item py-2" href="{{ url_for('todas_categorias') }}">
                                    <i class="fas fa-list me-2 text-primary"></i>
                                    Ver todas las categorías
                                </a>
                            </li>
                        </ul>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('ver_carrito') }}">
                            <i class="fas fa-shopping-cart me-1"></i> Carrito
                            {% if 'usuario_id' in session and carrito_count %}
                                <span class="badge badge-cart">{{ carrito_count }}</span>
                            {% endif %}
                        </a>
                    </li>

                    {% if 'usuario_id' in session and puntos_usuario is not none %}
                    <li class="nav-item puntos-container">
                        <div class="puntos-display animate__animated animate__pulse" title="Tus puntos de recompensa">
                            <i class="fas fa-coins"></i>
                            <span class="puntos-count">{{ puntos_usuario }}</span>
                            <span class="puntos-text">Puntos</span>
                        </div>
                    </li>
                    {% endif %}
                    
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('todas_ofertas') }}">
                            <i class="fas fa-gift me-1"></i> Ofertas
                        </a>
                    </li>
                    <li class="nav-item search-container me-5" data-bs-auto-close="outside">
                        <div class="position-relative w-100">
                            <form class="d-flex" method="GET" action="{{ url_for('buscar_productos') }}">
                                <div class="search-input-wrapper position-relative">
                                    <input class="form-control search-input ps-5" type="search" placeholder="Buscar productos..." 
                                           aria-label="Buscar" name="q" id="searchInput" autocomplete="off">
                                    <button class="btn search-btn position-absolute top-50 end-0 translate-middle-y me-3" type="submit">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                            </form>
                            <div id="searchSuggestions" class="position-absolute w-100 mt-1 rounded-4 shadow-lg overflow-hidden dropdown-item-li" 
                                 style="display: none;">
                                <!-- Las sugerencias se cargarán dinámicamente aquí -->
                            </div>
                        </div>
                    </li>
                    
                    {% if 'usuario_id' in session %}
                        <li class="nav-item dropdown" data-bs-auto-close="outside">
                            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                                <span class="user-avatar">{{ session['usuario_nombre'][0] }}</span>
                                {{ session['usuario_nombre'] }}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('perfil') }}">
                                        <i class="fas fa-user-circle me-2"></i> Mi Cuenta
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('mis_pedidos') }}">
                                        <i class="fas fa-box me-2"></i> Mis pedidos
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('mis_compras') }}">
                                        <i class="fas fa-box me-2"></i> Mis comprar
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item" href="{{ url_for('logout') }}">
                                        <i class="fas fa-sign-out-alt me-2"></i> Cerrar Sesión
                                    </a>
                                </li>
                            </ul>
                        </li>
                    {% else %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i> Cuenta
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li class="nav-item">
                                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#loginModal">
                                        <i class="fas fa-sign-in-alt me-2"></i> Iniciar Sesión
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#registroModal">
                                        <i class="fas fa-user-plus me-2"></i> Registrarse
                                    </a>
                                </li>
                            </ul>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <main class="container my-5 mensaje">
        <!-- Actualizar el bloque de mensajes flash para incluir éxito en restablecimiento -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="notification-container">
                    {% for category, message in messages %}
                        <div class="notification alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            <i class="fas 
                                {% if category == 'success' %}fa-check-circle
                                {% elif category == 'warning' %}fa-exclamation-triangle
                                {% elif category == 'danger' %}fa-times-circle
                                {% else %}fa-info-circle{% endif %} 
                                me-2"></i>
                            {{ message }}
                            <button type="button" class="btn-close px-2" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </main>

    <!-- Modales mejorados en base.html -->

    <!-- Modal de Inicio de Sesión mejorado -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header gradient-bg text-white">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-sign-in-alt fa-xl me-3"></i>
                        <h5 class="modal-title mb-0" id="loginModalLabel">Iniciar Sesión</h5>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ url_for('login') }}" method="POST" novalidate>
                    <div class="modal-body py-4">
                        <div class="mb-4 position-relative">
                            <i class="fas fa-envelope input-icon"></i>
                            <input type="email" class="form-control form-control-lg ps-5" id="login-email" name="email" 
                                   value="{{ form_data.email if form_data and active_modal == 'login' else '' }}" 
                                   placeholder="Correo Electrónico" required>
                            <div id="loginEmailError" class="text-danger small mt-2"></div>
                        </div>
                        
                        <div class="mb-4 position-relative">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" class="form-control form-control-lg ps-5" id="login-password" 
                                   name="password" placeholder="Contraseña" required>
                            <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('login-password', this)"></i>
                            <div id="loginPasswordError" class="text-danger small mt-2"></div>
                        </div>
                        
                        <div class="mb-4 form-check">
                            <input type="checkbox" class="form-check-input" id="remember" name="remember">
                            <label class="form-check-label ms-2" for="remember">Recordar mis datos</label>
                        </div>
                        
                        <button type="button" class="btn btn-primary w-100 gradient-btn py-3 fw-bold" onclick="submitLoginForm()">
                            <i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesión
                        </button>
                        
                        <div class="text-center mt-4">
                            <a href="#" class="text-primary fw-medium" data-bs-toggle="modal" 
                               data-bs-target="#forgotPasswordModal" data-bs-dismiss="modal">
                                ¿Olvidaste tu contraseña?
                            </a>
                        </div>
                        
                        <hr class="my-4">
                        
                        <div class="text-center">
                            <p class="mb-0">¿No tienes una cuenta? 
                                <a href="#" class="text-primary fw-medium" data-bs-toggle="modal" 
                                   data-bs-target="#registroModal" data-bs-dismiss="modal">
                                    Regístrate ahora
                                </a>
                            </p>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Registro mejorado -->
    <div class="modal fade" id="registroModal" tabindex="-1" aria-labelledby="registroModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header gradient-bg text-white">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-user-plus fa-xl me-3"></i>
                        <h5 class="modal-title mb-0" id="registroModalLabel">Crear Cuenta</h5>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{{ url_for('registro') }}" method="POST" novalidate>
                    <div class="modal-body py-3">
                        
                        
                        <!-- Identificación -->
                        <!-- Dentro del modal de registro en base.html -->
                        <div class="mb-4 position-relative">  <!-- Cambiado de mb-3 a mb-4 -->
                            <i class="fas fa-id-card input-icon"></i>
                            <input type="text" class="form-control form-control-lg ps-5" id="registro-identificacion" name="identificacion" 
                                   value="{{ form_data.identificacion if form_data and active_modal == 'registro' else '' }}" 
                                   placeholder="Número de Identificación" required>
                            <div id="registroIdentificacionError" class="text-danger small mt-1"></div>
                        </div>

                        <div class="mb-4 position-relative">  <!-- Cambiado de mb-3 a mb-4 -->
                            <i class="fas fa-user input-icon"></i>
                            <input type="text" class="form-control form-control-lg ps-5" id="registro-nombre" name="nombre" 
                                   value="{{ form_data.nombre if form_data and active_modal == 'registro' else '' }}" 
                                   placeholder="Nombre Completo" required>
                            <div id="registroNombreError" class="text-danger small mt-1"></div>
                        </div>

                        <div class="mb-4 position-relative">  <!-- Cambiado de mb-3 a mb-4 -->
                            <i class="fas fa-envelope input-icon"></i>
                            <input type="email" class="form-control form-control-lg ps-5" id="registro-email" name="email" 
                                   value="{{ form_data.email if form_data and active_modal == 'registro' else '' }}" 
                                   placeholder="Correo Electrónico" required>
                            <div id="registroEmailError" class="text-danger small mt-1"></div>
                        </div>

                        <div class="mb-4 position-relative">  <!-- Cambiado de mb-3 a mb-4 -->
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" class="form-control form-control-lg ps-5" id="registro-password" 
                                   name="password" placeholder="Contraseña" required>
                            <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('registro-password', this)"></i>
                            <div id="registroPasswordError" class="text-danger small mt-1"></div>
                        </div>

                        <div class="mb-4 position-relative">  <!-- Cambiado de mb-3 a mb-4 -->
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" class="form-control form-control-lg ps-5" id="registro-confirm-password" 
                                   name="confirm_password" placeholder="Confirmar Contraseña" required>
                            <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('registro-confirm-password', this)"></i>
                            <div id="registroConfirmPasswordError" class="text-danger small mt-1"></div>
                        </div>
                        
                        <!-- Términos y Condiciones -->
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="terms" name="terms" required>
                            <label class="form-check-label ms-2 small" for="terms">
                                Acepto los <a href="#" class="text-primary">Términos y Condiciones</a>
                            </label>
                            <div id="registroTermsError" class="text-danger small mt-1"></div>
                        </div>
                        
                        <!-- Botón de Registro -->
                        <button type="button" class="btn btn-primary w-100 gradient-btn py-2 fw-bold" onclick="submitRegistroForm()">
                            <i class="fas fa-user-plus me-2"></i>Registrarse
                        </button>
                        
                        <hr class="my-3">
                        
                        <!-- Enlace a Login -->
                        <div class="text-center">
                            <p class="mb-0 small">¿Ya tienes una cuenta? 
                                <a href="#" class="text-primary fw-medium" data-bs-toggle="modal" 
                                   data-bs-target="#loginModal" data-bs-dismiss="modal">
                                    Inicia Sesión
                                </a>
                            </p>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Actualizar el modal de restablecimiento de contraseña -->
    <div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-labelledby="forgotPasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header gradient-bg text-white">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-key fa-xl me-3"></i>
                        <h5 class="modal-title mb-0" id="forgotPasswordModalLabel">Restablecer Contraseña</h5>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body py-4">
                    <p class="mb-4">Ingresa tu nombre completo, correo electrónico registrado y tu nueva contraseña.</p>
                    <form id="forgotPasswordForm" method="POST" action="{{ url_for('forgot_password') }}" novalidate>
                        <div class="mb-4 position-relative">
                            <i class="fas fa-user input-icon"></i>
                            <input type="text" class="form-control form-control-lg ps-5" id="forgotNombre" name="nombre" 
                                   value="{{ forgot_form_data['nombre'] if forgot_form_data else '' }}" 
                                   placeholder="Nombre Completo" required>
                            <div id="forgotNombreError" class="text-danger small mt-2">
                                {% if forgot_errors and forgot_errors.get('nombre') %}
                                    {{ forgot_errors['nombre'] }}
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mb-4 position-relative">
                            <i class="fas fa-envelope input-icon"></i>
                            <input type="email" class="form-control form-control-lg ps-5" id="forgotEmail" name="email" 
                                   value="{{ forgot_form_data['email'] if forgot_form_data else '' }}" 
                                   placeholder="Correo Electrónico" required>
                            <div id="forgotEmailError" class="text-danger small mt-2">
                                {% if forgot_errors and forgot_errors.get('email') %}
                                    {{ forgot_errors['email'] }}
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mb-4 position-relative">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" class="form-control form-control-lg ps-5" id="forgotPassword" 
                                   name="password" placeholder="Nueva Contraseña" required>
                            <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('forgotPassword', this)"></i>
                            <div id="forgotPasswordError" class="text-danger small mt-2">
                                {% if forgot_errors and forgot_errors.get('password') %}
                                    {{ forgot_errors['password'] }}
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mb-4 position-relative">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" class="form-control form-control-lg ps-5" id="forgotConfirmPassword" 
                                   name="confirm_password" placeholder="Confirmar Nueva Contraseña" required>
                            <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('forgotConfirmPassword', this)"></i>
                            <div id="forgotConfirmPasswordError" class="text-danger small mt-2">
                                {% if forgot_errors and forgot_errors.get('confirm_password') %}
                                    {{ forgot_errors['confirm_password'] }}
                                {% endif %}
                            </div>
                        </div>
                        
                        <div id="forgotGeneralError" class="text-danger mb-3">
                            {% if forgot_errors and forgot_errors.get('general') %}
                                {{ forgot_errors['general'] }}
                            {% endif %}
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary gradient-btn px-4" onclick="submitForgotPassword()">
                        <i class="fas fa-redo me-2"></i>Restablecer
                    </button>
                </div>
            </div>
        </div>
    </div>




    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-lg-4 col-md-6 mb-5 mb-lg-0">
                    <div class="footer-logo">Merkavia</div>
                    <p class="footer-about">
                        Tu destino para encontrar los mejores productos al mejor precio. 
                        Ofrecemos calidad, variedad y un servicio excepcional para todas tus necesidades.
                    </p>
                    <div class="footer-social">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-linkedin-in"></i></a>
                        <a href="#"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                
                <div class="col-lg-2 col-md-6 mb-5 mb-md-0">
                    <h5>Enlaces</h5>
                    <ul class="footer-links">
                        <li><a href="{{ url_for('index') }}"><i class="fas fa-chevron-right"></i> Inicio</a></li>
                        <li><a href="{{ url_for('todos_productos') }}"><i class="fas fa-chevron-right"></i> Productos</a></li>
                        <li><a href="{{ url_for('todas_ofertas') }}"><i class="fas fa-chevron-right"></i> Ofertas</a></li>
                        <li><a href="{{ url_for('todos_destacados') }}"><i class="fas fa-chevron-right"></i> Populares</a></li>
                    </ul>
                </div>
                
                <div class="col-lg-2 col-md-6 mb-5 mb-md-0">
                    <h5>Soporte</h5>
                    <ul class="footer-links">
                        <li><a href="#"><i class="fas fa-chevron-right"></i> Contacto</a></li>
                        <li><a href="#"><i class="fas fa-chevron-right"></i> Términos</a></li>
                        <li><a href="#"><i class="fas fa-chevron-right"></i> Privacidad</a></li>
                        <li><a href="#"><i class="fas fa-chevron-right"></i> Envíos</a></li>
                    </ul>
                </div>
                
                <div class="col-lg-4 col-md-6">
                    <h5>Contacto</h5>
                    <ul class="footer-contact">
                        <li>
                            <i class="fas fa-map-marker-alt"></i>
                            <div>Calle Principal 4a, Ciudad Barranquiila, CP 28001</div>
                        </li>
                        <li>
                            <i class="fas fa-phone-alt"></i>
                            <div>+57 3044931728</div>
                        </li>
                        <li>
                            <i class="fas fa-envelope"></i>
                            <div>info@megatienda.com</div>
                        </li>
                        <li>
                            <i class="fas fa-clock"></i>
                            <div>Lunes a Viernes: 9:00 - 20:00<br>Sábados: 10:00 - 18:00</div>
                        </li>
                    </ul>
                    
                </div>
            </div>
            
            <div class="footer-bottom">
                <div class="container">
                    <div class="row">
                        <div class="col-md-6 text-center text-md-start">
                            <p>&copy; 2025 Mega Tienda. Todos los derechos reservados.</p>
                        </div>
                        <div class="col-md-6 text-center text-md-end">
                            <p>
                                <a href="#" class="text-white me-3">Términos y Condiciones</a>
                                <a href="#" class="text-white">Política de Privacidad</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
    // Manejo de dropdowns
    document.querySelectorAll('.nav-item.dropdown > .dropdown-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(e) {
            e.preventDefault();
            const parentItem = this.closest('.dropdown');
            
            document.querySelectorAll('.dropdown').forEach(item => {
                if (item !== parentItem) item.classList.remove('show');
            });
            
            parentItem.classList.toggle('show');
        });
    });

    // Cerrar dropdowns al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.dropdown') && 
            !e.target.classList.contains('dropdown-toggle') && 
            !e.target.closest('.dropdown-toggle')) {
            document.querySelectorAll('.dropdown').forEach(item => {
                item.classList.remove('show');
            });
        }
    });

    // Limpiar campos al cerrar modales
    const loginModalElement = document.getElementById('loginModal');
    const registroModalElement = document.getElementById('registroModal');
    const forgotPasswordModalElement = document.getElementById('forgotPasswordModal');
    
    if (loginModalElement) {
        loginModalElement.addEventListener('hidden.bs.modal', clearLoginFields);
    }
    
    if (registroModalElement) {
        registroModalElement.addEventListener('hidden.bs.modal', clearRegistroFields);
    }
    
    if (forgotPasswordModalElement) {
        forgotPasswordModalElement.addEventListener('hidden.bs.modal', clearForgotPasswordFields);
    }

    // Alternar entre modales de login y registro
    // Alternar entre modales de login y registro
    document.querySelectorAll('[data-bs-target="#loginModal"][data-bs-dismiss="modal"]').forEach(btn => {
        btn.addEventListener('click', function() {
            if (registroModal) {
                registroModal.hide();
                clearRegistroFields();
            }
            setTimeout(() => {
                if (loginModal) loginModal.show();
            }, 300);
        });
    });

    document.querySelectorAll('[data-bs-target="#registroModal"][data-bs-dismiss="modal"]').forEach(btn => {
        btn.addEventListener('click', function() {
            if (loginModal) {
                loginModal.hide();
                clearLoginFields();
            }
            setTimeout(() => {
                if (registroModal) registroModal.show();
            }, 300);
        });
    });

    // Cerrar modales al hacer clic fuera
    window.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            const modalInstance = bootstrap.Modal.getInstance(e.target);
            if (modalInstance) {
                if (e.target.id === 'loginModal') clearLoginFields();
                else if (e.target.id === 'registroModal') clearRegistroFields();
                else if (e.target.id === 'forgotPasswordModal') clearForgotPasswordFields();
                modalInstance.hide();
            }
        }
    });

    // Manejo de mensajes flash
    const notifications = document.querySelectorAll('.notification');
    notifications.forEach(notification => {
        setTimeout(() => {
            notification.classList.add('animate__animated', 'animate__fadeOut');
            setTimeout(() => notification.remove(), 500);
        }, 5000);
    });

    // Configuración de búsqueda
    const searchInput = document.getElementById('searchInput');
    const searchSuggestions = document.getElementById('searchSuggestions');
    
    if (searchInput && searchSuggestions) {
        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            if (query.length === 0) {
                searchSuggestions.style.display = 'none';
                return;
            }
            
            fetch(`/sugerencias-busqueda?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    searchSuggestions.innerHTML = '';
                    if (data.length > 0) {
                        data.forEach(producto => {
                            const div = document.createElement('div');
                            div.className = 'p-2 hover-suggestion dropdown-item';
                            div.textContent = producto.nombre;
                            div.addEventListener('click', function() {
                                searchInput.value = producto.nombre;
                                searchSuggestions.style.display = 'none';
                                window.location.href = `/producto/${producto.id}`;
                            });
                            searchSuggestions.appendChild(div);
                        });
                        searchSuggestions.style.display = 'block';
                    } else {
                        searchSuggestions.style.display = 'none';
                    }
                })
                .catch(error => console.error('Error fetching suggestions:', error));
        });
        
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !searchSuggestions.contains(e.target)) {
                searchSuggestions.style.display = 'none';
            }
        });
    }
    
    // Apertura automática de modales con errores (SOLUCIÓN CLAVE)
    setTimeout(function() {
        {% if active_modal == 'login' and errors %}
            if (document.querySelector('#loginModal .text-danger')) {
                const modal = new bootstrap.Modal(document.getElementById('loginModal'));
                modal.show();
            }
        {% elif active_modal == 'registro' and errors %}
            if (document.querySelector('#registroModal .text-danger')) {
                const modal = new bootstrap.Modal(document.getElementById('registroModal'));
                modal.show();
            }
        {% endif %}
    }, 300);
});

function handleFormResponse(response) {
    if (!response.ok) {
        return response.json().then(data => {
            if (data.errors) {
                return Promise.reject(data.errors);
            }
            throw new Error('Error en la respuesta del servidor');
        });
    }
    return response.json();
}



// Función para limpiar errores después de un tiempo
function clearErrorsAfterTimeout(modalId, timeout = 5000) {
    const modalElement = document.getElementById(modalId);
    if (modalElement) {
        const errorElements = modalElement.querySelectorAll('.text-danger');
        const timeoutIds = [];
        
        errorElements.forEach(el => {
            const timeoutId = setTimeout(() => {
                el.textContent = '';
            }, timeout);
            timeoutIds.push(timeoutId);
        });
        
        // Limpiar timeouts cuando se cierra el modal
        modalElement.addEventListener('hidden.bs.modal', () => {
            timeoutIds.forEach(id => clearTimeout(id));
        });
    }
}



function submitForgotPassword() {
    clearForgotPasswordErrors();
    
    const nombre = document.getElementById('forgotNombre').value.trim();
    const email = document.getElementById('forgotEmail').value.trim();
    const password = document.getElementById('forgotPassword').value;
    const confirmPassword = document.getElementById('forgotConfirmPassword').value;
    
    let hasErrors = false;
    
    if (!nombre) {
        document.getElementById('forgotNombreError').textContent = 'Por favor ingresa tu nombre completo';
        hasErrors = true;
    }
    
    if (!email) {
        document.getElementById('forgotEmailError').textContent = 'Por favor ingresa tu correo electrónico';
        hasErrors = true;
    } else if (!/^[\w.-]+@[\w.-]+\.\w+$/.test(email)) {
        document.getElementById('forgotEmailError').textContent = 'Correo electrónico no válido';
        hasErrors = true;
    }
    
    if (!password) {
        document.getElementById('forgotPasswordError').textContent = 'Por favor ingresa tu nueva contraseña';
        hasErrors = true;
    } else if (password.length < 6) {
        document.getElementById('forgotPasswordError').textContent = 'La contraseña debe tener al menos 6 caracteres';
        hasErrors = true;
    }
    
    if (!confirmPassword) {
        document.getElementById('forgotConfirmPasswordError').textContent = 'Por favor confirma tu nueva contraseña';
        hasErrors = true;
    } else if (password !== confirmPassword) {
        document.getElementById('forgotConfirmPasswordError').textContent = 'Las contraseñas no coinciden';
        hasErrors = true;
    }
    
    if (hasErrors) {
        clearErrorsAfterTimeout('forgotPasswordModal');
        return;
    }
    
    const form = document.getElementById('forgotPasswordForm');
    const formData = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: { 'Accept': 'application/json' }
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            const modalElement = document.getElementById('forgotPasswordModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            modal.hide();
            
            showFlashMessage('success', data.message);
            
            const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            loginModal.show();
        } else {
            if (data.errors) {
                for (const [field, error] of Object.entries(data.errors)) {
                    const errorElement = document.getElementById(`forgot${field.charAt(0).toUpperCase() + field.slice(1)}Error`);
                    if (errorElement) errorElement.textContent = error;
                }
                clearErrorsAfterTimeout('forgotPasswordModal');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('forgotGeneralError').textContent = 'Ocurrió un error. Por favor intenta de nuevo.';
        clearErrorsAfterTimeout('forgotPasswordModal');
    });
}

function submitLoginForm() {
    clearLoginErrors();
    
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;
    
    let hasErrors = false;
    
    if (!email) {
        document.getElementById('loginEmailError').textContent = 'Por favor ingresa tu correo electrónico';
        hasErrors = true;
    } else if (!/^[\w.-]+@[\w.-]+\.\w+$/.test(email)) {
        document.getElementById('loginEmailError').textContent = 'Correo electrónico no válido';
        hasErrors = true;
    }
    
    if (!password) {
        document.getElementById('loginPasswordError').textContent = 'Por favor ingresa tu contraseña';
        hasErrors = true;
    }
    
    if (hasErrors) {
        clearErrorsAfterTimeout('loginModal');
        return;
    }
    
    const form = document.querySelector('#loginModal form');
    const formData = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: { 'Accept': 'application/json' }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
            modal.hide();
            
            showFlashMessage('success', data.message);
            
            // Redirección basada en la respuesta del servidor
            if (data.redirect) {
                window.location.href = data.redirect;
            } else {
                // Redirección por defecto si no hay URL específica
                window.location.href = '/';
            }
        } else {
            if (data.errors) {
                for (const [field, error] of Object.entries(data.errors)) {
                    const errorElement = document.getElementById(`login${field.charAt(0).toUpperCase() + field.slice(1)}Error`);
                    if (errorElement) errorElement.textContent = error;
                }
                clearErrorsAfterTimeout('loginModal');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showFlashMessage('danger', 'Ocurrió un error. Por favor intenta de nuevo.');
    });
}

function submitRegistroForm() {
    clearRegistroErrors();
    
    const nombre = document.getElementById('registro-nombre').value.trim();
    const identificacion = document.getElementById('registro-identificacion').value.trim();
    const email = document.getElementById('registro-email').value.trim();
    const password = document.getElementById('registro-password').value;
    const confirmPassword = document.getElementById('registro-confirm-password').value;
    const terms = document.getElementById('terms').checked;
    
    let hasErrors = false;
    
    // Validación de nombre
    if (!nombre) {
        document.getElementById('registroNombreError').textContent = 'Por favor ingresa tu nombre completo';
        hasErrors = true;
    }
    
    // Validación de identificación
    if (!identificacion) {
        document.getElementById('registroIdentificacionError').textContent = 'Por favor ingresa tu número de identificación';
        hasErrors = true;
    } else if (!/^\d{6,12}$/.test(identificacion)) {
        document.getElementById('registroIdentificacionError').textContent = 'La identificación debe tener entre 6 y 12 dígitos';
        hasErrors = true;
    }
    
    // Validación de email
    if (!email) {
        document.getElementById('registroEmailError').textContent = 'Por favor ingresa tu correo electrónico';
        hasErrors = true;
    } else if (!/^[\w.-]+@[\w.-]+\.\w+$/.test(email)) {
        document.getElementById('registroEmailError').textContent = 'Correo electrónico no válido';
        hasErrors = true;
    }
    
    // Validación de contraseña
    if (!password) {
        document.getElementById('registroPasswordError').textContent = 'Por favor ingresa tu contraseña';
        hasErrors = true;
    } else if (password.length < 6) {
        document.getElementById('registroPasswordError').textContent = 'La contraseña debe tener al menos 6 caracteres';
        hasErrors = true;
    }
    
    // Validación de confirmación de contraseña
    if (!confirmPassword) {
        document.getElementById('registroConfirmPasswordError').textContent = 'Por favor confirma tu contraseña';
        hasErrors = true;
    } else if (password !== confirmPassword) {
        document.getElementById('registroConfirmPasswordError').textContent = 'Las contraseñas no coinciden';
        hasErrors = true;
    }
    
    // Validación de términos y condiciones
    if (!terms) {
        document.getElementById('registroTermsError').textContent = 'Debes aceptar los Términos y Condiciones';
        hasErrors = true;
    }
    
    if (hasErrors) {
        clearErrorsAfterTimeout('registroModal');
        return;
    }
    
    const form = document.querySelector('#registroModal form');
    const formData = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: { 'Accept': 'application/json' }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('registroModal'));
            modal.hide();
            
            showFlashMessage('success', data.message || 'Registro exitoso. Ahora puedes iniciar sesión');
            
            setTimeout(() => {
                const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
                loginModal.show();
            }, 1000);
        } else {
            if (data.errors) {
                for (const [field, error] of Object.entries(data.errors)) {
                    const errorElement = document.getElementById(`registro${field.charAt(0).toUpperCase() + field.slice(1)}Error`);
                    if (errorElement) errorElement.textContent = error;
                }
                clearErrorsAfterTimeout('registroModal');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showFlashMessage('danger', 'Ocurrió un error. Por favor intenta de nuevo.');
    });
}

// Actualizar función para limpiar errores
function clearRegistroErrors() {
    document.getElementById('registroNombreError').textContent = '';
    document.getElementById('registroIdentificacionError').textContent = '';
    document.getElementById('registroEmailError').textContent = '';
    document.getElementById('registroPasswordError').textContent = '';
    document.getElementById('registroConfirmPasswordError').textContent = '';
    document.getElementById('registroTermsError').textContent = '';
}

// Actualizar función para limpiar campos
function clearRegistroFields() {
    document.getElementById('registro-nombre').value = '';
    document.getElementById('registro-identificacion').value = '';
    document.getElementById('registro-email').value = '';
    document.getElementById('registro-password').value = '';
    document.getElementById('registro-confirm-password').value = '';
    document.getElementById('terms').checked = false;
    clearRegistroErrors();
}

// Funciones auxiliares para limpiar errores
function clearLoginErrors() {
    document.getElementById('loginEmailError').textContent = '';
    document.getElementById('loginPasswordError').textContent = '';
}


function clearForgotPasswordErrors() {
    document.querySelectorAll('#forgotNombreError, #forgotEmailError, #forgotPasswordError, #forgotConfirmPasswordError, #forgotGeneralError')
        .forEach(el => el.textContent = '');
}

// Funciones para limpiar campos de formularios
function clearLoginFields() {
    document.getElementById('login-email').value = '';
    document.getElementById('login-password').value = '';
    document.getElementById('remember').checked = false;
    clearLoginErrors();
}

function clearForgotPasswordFields() {
    document.getElementById('forgotNombre').value = '';
    document.getElementById('forgotEmail').value = '';
    document.getElementById('forgotPassword').value = '';
    document.getElementById('forgotConfirmPassword').value = '';
    clearForgotPasswordErrors();
}



function showFlashMessage(type, message) {
    const notificationContainer = document.querySelector('.notification-container') || document.createElement('div');
    if (!document.querySelector('.notification-container')) {
        notificationContainer.className = 'notification-container';
        document.querySelector('main').prepend(notificationContainer);
    }
    
    const notification = document.createElement('div');
    notification.className = `notification alert alert-${type} alert-dismissible fade show`;
    notification.setAttribute('role', 'alert');
    notification.innerHTML = `
        <i class="fas 
            ${type === 'success' ? 'fa-check-circle' : 
              type === 'warning' ? 'fa-exclamation-triangle' : 
              type === 'danger' ? 'fa-times-circle' : 'fa-info-circle'} 
            me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    notificationContainer.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('animate__animated', 'animate__fadeOut');
        setTimeout(() => notification.remove(), 500);
    }, 5000);
}

function togglePasswordVisibility(inputId, iconElement) {
    const input = document.getElementById(inputId);
    if (input.type === 'password') {
        input.type = 'text';
        iconElement.classList.remove('fa-eye');
        iconElement.classList.add('fa-eye-slash');
    } else {
        input.type = 'password';
        iconElement.classList.remove('fa-eye-slash');
        iconElement.classList.add('fa-eye');
    }
}

// Agrega esto al final de tus scripts
document.addEventListener('DOMContentLoaded', function() {
    // Observar cambios en los puntos (si los actualizas dinámicamente)
    const puntosDisplay = document.querySelector('.puntos-display');
    if (puntosDisplay) {
        // Ejemplo: si actualizas los puntos dinámicamente
        // puedes agregar la clase 'puntos-updated' para animarlos
        puntosDisplay.addEventListener('DOMSubtreeModified', function() {
            this.classList.add('puntos-updated');
            setTimeout(() => this.classList.remove('puntos-updated'), 500);
        });
    }
});
</script>
</body>
</html>